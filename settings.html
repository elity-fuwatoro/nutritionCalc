<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>設定 - 栄養計算機</title>
    <style>
        body {
            font-family: sans-serif;
            max-width: fit-content;
            margin: 0 auto;
            padding: 20px;
        }

        .input-s {
            width: 30px;
        }

        .input-m {
            width: 50px;
        }

        .input-l {
            width: 90px;
        }

        label {
            font-weight: bold;
        }

        input {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        input:focus {
            outline: 1px solid #007bff;
            border-color: #007bff;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            overflow: auto;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }

        th {
            background-color: #ffffff;
            position: sticky;
            top: 0;
        }

        .fixedName {
            position: sticky;
            left: 0;
            z-index: 1;
        }

        #DIALOG {
            /* 大きさをウインドサイズに連動して可変にする */
            box-sizing: border-box;
            /* padding, border も含めた大きさにする */
            height: 85%;
            /* % で指定して可変サイズにする */
            width: 85%;
            background: #333;
            opacity: 0.95;
            padding: 1.5em;
            border-radius: 10px;
        }

        #DIALOG textarea {
            margin: 1em 0 0 0;
            box-sizing: border-box;
            width: 100%;
            height: calc(100% - 60px);
            /* ボタンの高さの分を引く */

            background: #ddd;
            padding: 0.5em;
            color: #222;
            font-size: 10.5pt;
            line-height: 1.6;
        }
    </style>
</head>

<body>
<div class="container">
    <div>
        <h2>設定画面</h2>
        <button onclick="location.href='index.html'">計算シートに戻る</button>
        <p>1000ccあたりのデータを記載して下さい。<br>電解質は内部的にはmgで保持。経腸栄養でなければmEqになおして表示
        </p>
        <p>
            <button onclick="showModalDialog()">ふっかつのじゅもんを表示/編集</button>
            <button onclick="initializePac()">製剤一覧をデモデータに</button>
        </p>
        <p>
            <button onclick="showHide();">表示量少なく</button>
        </p>
        <dialog id="DIALOG" onclose="closeDialog(this);">
            <form method="dialog">
                <button value="cancel">閉じる</button>
                <button value="submit">ふっかつする</button>
            </form>
            <label for="restore"></label><textarea id="restore">読込中・・・
                        </textarea>
        </dialog>
        <table id="pacTable">
            <colgroup>
                <col>
                <col>
                <col>
                <col>
                <col class="input-nut">
                <col class="input-nut">
                <col class="input-nut">
                <col class="input-nut">
                <col class="input-vit">
                <col class="input-vit">
                <col class="input-vit">
                <col class="input-vit">
            </colgroup>
            <thead>
            <tr>
                <th>削除</th>
                <th>id</th>
                <th>経腸</th>
                <th class="fixedName">製剤名</th>
                <th>総Cal</th>
                <th>水分</th>
                <th>蛋白</th>
                <th>糖質</th>
                <th>1pac量</th>
                <th>Na</th>
                <th>K</th>
                <th>浸透圧比</th>
            </tr>
            </thead>
            <tbody id="pacBody"></tbody>
        </table>
    </div>

</div>
<script>
    let db;
    const DB_NAME = 'NutDatabase';
    const STORE_NAME = 'inputBackUp';
    const DATA_STORE = 'NutLists';


    // データベースを初期化
    const request = indexedDB.open(DB_NAME, 1);

    request.onerror = (event) => {
        console.error('Database error:', event.target.error);
    };

    request.onupgradeneeded = (event) => {
        db = event.target.result;
        if (!db.objectStoreNames.contains(STORE_NAME)) {
            db.createObjectStore(STORE_NAME, {keyPath: 'id'});
        }
        if (!db.objectStoreNames.contains(DATA_STORE)) {
            db.createObjectStore(DATA_STORE, {keyPath: 'id'});
        }
    };

    request.onsuccess = (event) => {
        db = event.target.result;
        getPack();
        // showHide();
    };

    function showHide() {
        //おそらくvisibility初期値はnullとかなので、elseの方に行くと思われ、vitの方は初回起動時にcollapse、nutの方はvisibleに設定する
        document.getElementById('pacTable').querySelectorAll('.input-vit')
            .forEach(vitCol => {
                const isVi = vitCol.style.visibility;
                if (isVi === "collapse") {
                    vitCol.style.visibility = "visible";
                } else {
                    vitCol.style.visibility = "collapse";
                }
            });
        document.getElementById('pacTable').querySelectorAll('.input-nut')
            .forEach(vitCol => {
                const isVi = vitCol.style.visibility;
                if (isVi === "visible") {
                    vitCol.style.visibility = "collapse";
                } else {
                    vitCol.style.visibility = "visible";
                }
            });
    }

    function makeFirstNutLists() {
        document.getElementById('restore').value = '[{"id":0,"name":"ビーフリード","pack":"500ml","volume":0,"totalCal":420,"water":1000,"protein":30,"glu":75,"osmratio":3,"na":805,"k":780},{"id":1,"name":"アミパレン","pack":"200/300ml","volume":0,"totalCal":400,"water":1000,"protein":100,"glu":0,"osmratio":3,"na":46,"k":0},{"id":2,"name":"キドミン","pack":"200/300ml","volume":0,"totalCal":288,"water":1000,"protein":72,"glu":0,"osmratio":2,"na":46,"k":0},{"id":3,"name":"フルカリック1","pack":"903ml","volume":0,"totalCal":620,"water":1000,"protein":21,"glu":132.9,"osmratio":4,"na":1265,"k":1287},{"id":4,"name":"フルカリック2","pack":"1003ml","volume":0,"totalCal":817.5,"water":1000,"protein":30,"glu":174.5,"osmratio":5,"na":1150,"k":1170},{"id":5,"name":"フルカリック3","pack":"1103ml","volume":0,"totalCal":1051.7,"water":1000,"protein":36,"glu":226.7,"osmratio":6,"na":1035,"k":1053},{"id":6,"name":"エルネオパ1","pack":"1L/1.5L","volume":0,"totalCal":560,"water":1000,"protein":20.13,"glu":120,"osmratio":4,"na":1150,"k":858},{"id":7,"name":"エルネオパ2","pack":"1L/1.5L","volume":0,"totalCal":820,"water":1000,"protein":30,"glu":175,"osmratio":6,"na":1150,"k":1053},{"id":8,"name":"トリフリード","pack":"1L","volume":0,"totalCal":420,"water":1000,"protein":0,"glu":60,"osmratio":3,"na":805,"k":780},{"id":9,"name":"生食","pack":"500ml/1L","volume":0,"totalCal":0,"water":1000,"protein":0,"glu":0,"osmratio":1,"na":3542,"k":0},{"id":10,"name":"10%食塩水","pack":"20ml/1A","volume":0,"totalCal":0,"water":1000,"protein":0,"glu":0,"osmratio":11,"na":39100,"k":0},{"id":11,"name":"ソルアセトF","pack":"500ml","volume":0,"totalCal":0,"water":1000,"protein":0,"glu":0,"osmratio":1,"na":3013,"k":156},{"id":12,"name":"ソリタT1","pack":"200/500ml","volume":0,"totalCal":104,"water":1000,"protein":0,"glu":26,"osmratio":1,"na":2070,"k":0},{"id":13,"name":"ソルデム3A","pack":"500ml","volume":0,"totalCal":172,"water":1000,"protein":0,"glu":43,"osmratio":1,"na":805,"k":780},{"id":14,"name":"ソルデム3AG","pack":"200/500ml","volume":0,"totalCal":300,"water":1000,"protein":0,"glu":75,"osmratio":2,"na":805,"k":780},{"id":15,"name":"ソルデム6","pack":"500ml","volume":0,"totalCal":160,"water":1000,"protein":0,"glu":40,"osmratio":1,"na":690,"k":0},{"id":16,"name":"5%ブドウ糖液","pack":"20/250/500ml","volume":0,"totalCal":200,"water":1000,"protein":0,"glu":50,"osmratio":1,"na":0,"k":0},{"id":17,"name":"10%ブドウ糖液","pack":"500ml","volume":0,"totalCal":400,"water":1000,"protein":0,"glu":100,"osmratio":2,"na":0,"k":0},{"id":18,"name":"50%ブドウ糖液","pack":"20/200ml","volume":0,"totalCal":2000,"water":1000,"protein":0,"glu":500,"osmratio":12,"na":0,"k":0},{"id":19,"name":"KCL注","pack":"20mEq/20ml","volume":0,"totalCal":0,"water":1000,"protein":0,"glu":0,"osmratio":6,"na":0,"k":39000},{"id":20,"name":"白湯","pack":"","volume":0,"totalCal":0,"water":1000,"protein":0,"glu":0,"osmratio":null,"na":0,"k":0},{"id":21,"name":"ラコール半固形","pack":"300g","volume":0,"totalCal":1000,"water":760,"protein":43.8,"glu":156.2,"osmratio":null,"na":738,"k":1380},{"id":22,"name":"ハイネックスゼリー","pack":"300g","volume":0,"totalCal":1000,"water":760,"protein":45,"glu":131.6,"osmratio":null,"na":1770,"k":1840},{"id":23,"name":"エネーボ","pack":"250ml/缶","volume":0,"totalCal":1200,"water":812,"protein":54,"glu":158.4,"osmratio":null,"na":920,"k":1200},{"id":24,"name":"エンシュアH","pack":"250ml/缶","volume":0,"totalCal":1500,"water":776,"protein":52.8,"glu":206,"osmratio":null,"na":1200,"k":2240},{"id":25,"name":"エンシュア・リキッド","pack":"250ml","volume":0,"totalCal":1000,"water":852,"protein":35.2,"glu":137.2,"osmratio":null,"na":800,"k":1480},{"id":26,"name":"イノラス","pack":"125/187.5ml","volume":0,"totalCal":1600,"water":744,"protein":64,"glu":212.24,"osmratio":null,"na":1440,"k":2944},{"id":27,"name":"ラコールNF","pack":"200/400ml","volume":0,"totalCal":1000,"water":850,"protein":44,"glu":156.2,"osmratio":null,"na":738,"k":1380},{"id":28,"name":"アイソカルクリア","pack":"200ml/pac","volume":0,"totalCal":1000,"water":830,"protein":50,"glu":200,"osmratio":null,"na":0,"k":0},{"id":29,"name":"アイソカルサポート","pack":"200ml/1L","volume":0,"totalCal":1500,"water":765,"protein":57,"glu":153,"osmratio":null,"na":1350,"k":1200},{"id":30,"name":"ハイネイーゲル","pack":"500ml","volume":0,"totalCal":800,"water":880,"protein":32,"glu":134.4,"osmratio":null,"na":1330,"k":1250},{"id":31,"name":"リーナレンMP","pack":"125ml/pac","volume":0,"totalCal":1600,"water":748.8,"protein":56,"glu":240,"osmratio":null,"na":960,"k":480},{"id":32,"name":"インスロー","pack":"200ml/pac","volume":0,"totalCal":1000,"water":844,"protein":50,"glu":122,"osmratio":null,"na":1100,"k":1000}]';

        restoreIndexedDB();
    }

    function savePacInputValues(id, name, pack, volume, totalCal, water, protein, glu, osmratio, na, k) {
        const transaction = db.transaction([DATA_STORE], 'readwrite');
        const store = transaction.objectStore(DATA_STORE);
        store.put({
            id: id,
            name: name,
            pack: pack,
            volume: volume,
            totalCal: totalCal,
            water: water,
            protein: protein,
            glu: glu,
            osmratio: osmratio,
            na: na,
            k: k,
        });
    }

    //製剤を読み込む
    function getPack() {
        const transaction = db.transaction([DATA_STORE], 'readonly');
        const store = transaction.objectStore(DATA_STORE);
        const request = store.getAll();

        request.onsuccess = () => {
            let maxID = 0;
            const records = request.result;
            document.getElementById('restore').value = JSON.stringify(records);
            const tbody = document.getElementById('pacBody');
            tbody.innerHTML = '';

            records.sort((a, b) => a.id - b.id)
                .forEach(record => {
                    const row = tbody.insertRow();
                    const isPack = record.osmratio == null;
                    const viewNa = isPack ? record.na : (record.na / 23).toFixed(0); //経腸であればそのままmgで表示、点滴であればmEqに直して表示
                    const viewK = isPack ? record.k : (record.k / 39).toFixed(0);
                    row.insertCell().innerHTML = `<button onclick="delRow(this)">－</button>`;
                    row.insertCell().innerHTML = `<div class="resID">${record.id}</div>`;
                    row.insertCell().innerHTML = `<input type="checkbox"  onchange="changePack(this)" ${isPack ? 'checked' : ''} />`;
                    let nameCell = row.insertCell();
                    nameCell.innerHTML = `<input type="text" class="pacValue input-l name" value="${record.name}">`;
                    nameCell.className = "fixedName";
                    row.insertCell().innerHTML = `<input type="number" class="pacValue input-m totalCal" value="${record.totalCal}">kcal`;
                    row.insertCell().innerHTML = `<input type="number" class="pacValue input-m water" value="${record.water}">ml`;
                    row.insertCell().innerHTML = `<input type="number" class="pacValue input-s protein" value="${record.protein}">g`;
                    row.insertCell().innerHTML = `<input type="number" class="pacValue input-m glu" value="${record.glu}">g`;
                    row.insertCell().innerHTML = `<input type="text" class="pacValue input-l pack" value="${record.pack}">`;
                    row.insertCell().innerHTML = `<input type="number" class="pacValue input-m na" value="${viewNa}">${isPack ? '<span class="unit">mg</span>' : '<span class="unit">mEq</span>'}`;
                    row.insertCell().innerHTML = `<input type="number" class="pacValue input-m k" value="${viewK}">${isPack ? '<span class="unit">mg</span>' : '<span class="unit">mEq</span>'}`;
                    row.insertCell().innerHTML = `<input type="number" class="pacValue input-s osm" value="${record.osmratio || ''}" ${isPack ? 'disabled' : ''} />`;
                    maxID = Math.max(maxID, record.id);
                });
            document.getElementById('pacTable').querySelectorAll('.pacValue')
                .forEach(pacVal => {
                    pacVal.addEventListener('input', inputVolume);
                });
            const row = tbody.insertRow();
            row.insertCell().innerHTML = '<button onclick="addRow(this)">＋</button>';
            row.insertCell().innerHTML = `<div class="resID">${maxID + 1}</div>`;
            // document.getElementById('pacTable').querySelector('.pacValue').dispatchEvent(new Event('input'));
        };

    }

    function inputVolume() {
        const inputID = Number(this.parentNode.parentNode.querySelector('.resID').textContent);
        const totalCal = Number(this.parentNode.parentNode.querySelector('.totalCal').value);
        const name = this.parentNode.parentNode.querySelector('.name').value;
        const water = Number(this.parentNode.parentNode.querySelector('.water').value);
        const protein = Number(this.parentNode.parentNode.querySelector('.protein').value);
        const glu = Number(this.parentNode.parentNode.querySelector('.glu').value);
        const pack = this.parentNode.parentNode.querySelector('.pack').value;
        const inputNa = Number(this.parentNode.parentNode.querySelector('.na').value);
        const inputK = Number(this.parentNode.parentNode.querySelector('.k').value);
        const inputosm = this.parentNode.parentNode.querySelector('.osm').value;

        const isPack = inputosm === ''; //空欄ならtrue=経腸栄養と判断
        const na = isPack ? inputNa : inputNa * 23;
        const k = isPack ? inputK : inputK * 39;
        const osm = isPack ? null : Number(inputosm);

        savePacInputValues(inputID, name, pack, 0, totalCal, water, protein, glu, osm, na, k);
    }

    function addRow(con) {
        const row = con.parentElement.parentElement;
        const inputID = Number(con.parentNode.parentNode.querySelector('.resID').textContent);
        row.insertCell().innerHTML = `<input type="checkbox" onchange="changePack(this)" />`;
        let nameCell = row.insertCell();
        nameCell.innerHTML = `<input type="text" class="pacValue input-l name" value="">`;
        nameCell.className = "fixedName";
        row.insertCell().innerHTML = `<input type="number" class="pacValue input-m totalCal" value="0">kcal`;
        row.insertCell().innerHTML = `<input type="number" class="pacValue input-m water" value="0">ml`;
        row.insertCell().innerHTML = `<input type="number" class="pacValue input-s protein" value="0">g`;
        row.insertCell().innerHTML = `<input type="number" class="pacValue input-m glu" value="0">g`;
        row.insertCell().innerHTML = `<input type="text" class="pacValue input-l pack" value="">`;
        row.insertCell().innerHTML = `<input type="number" class="pacValue input-m na" value="0"><span class="unit">mEq</span>`;
        row.insertCell().innerHTML = `<input type="number" class="pacValue input-m k" value="0"><span class="unit">mEq</span>`;
        row.insertCell().innerHTML = `<input type="number" class="pacValue input-s osm" value="1" />`;

        document.getElementById('pacTable').querySelectorAll('.pacValue')
            .forEach(pacVal => {
                pacVal.addEventListener('input', inputVolume);
            });

        const delBut = con.parentNode.parentNode.querySelector('button');
        delBut.setAttribute('onclick', 'delRow(this)');
        delBut.innerText = "－";

        const tbody = document.getElementById('pacBody');
        const newRow = tbody.insertRow();
        newRow.insertCell().innerHTML = '<button onclick="addRow(this)">＋</button>';
        newRow.insertCell().innerHTML = `<div class="resID">${inputID + 1}</div>`;
    }


    //経腸栄養のチェックボックスがクリックされたとき
    function changePack(con) {
        const boolPack = con.checked;
        if (confirm("チェックするとNa,KでmEqとmgの変換が行われ微妙に数値がズレ、浸透圧比は1もしくはなしにリセットされますがよろしいですか？")) {
            if (boolPack) {
                con.parentNode.parentNode.querySelector('.osm').value = "";
                con.parentNode.parentNode.querySelector('.osm').disabled = true;
                con.parentNode.parentNode.querySelector('.na').value = Number(con.parentNode.parentNode.querySelector('.na').value) * 23;
                con.parentNode.parentNode.querySelector('.k').value = Number(con.parentNode.parentNode.querySelector('.k').value) * 39;
                con.parentNode.parentNode.querySelectorAll('.unit')
                    .forEach(un => {
                        un.innerText = "mg";
                    });
            } else {
                con.parentNode.parentNode.querySelector('.osm').value = "1";
                con.parentNode.parentNode.querySelector('.osm').disabled = false;
                con.parentNode.parentNode.querySelector('.na').value = (Number(con.parentNode.parentNode.querySelector('.na').value) / 23).toFixed(0);
                con.parentNode.parentNode.querySelector('.k').value = (Number(con.parentNode.parentNode.querySelector('.k').value) / 39).toFixed(0);
                con.parentNode.parentNode.querySelectorAll('.unit')
                    .forEach(un => {
                        un.innerText = "mEq";
                    });
            }
            con.parentNode.parentNode.querySelector('.osm').dispatchEvent(new Event('input'));
        } else {
            con.checked = !boolPack; //キャンセルなので、チェック状態も元にもどす
        }
    }

    function delRow(con) {
        const inputID = Number(con.parentNode.parentNode.querySelector('.resID').textContent);
        const name = con.parentNode.parentNode.querySelector('.name').value;
        if (confirm(`${name}(ID:${inputID})を削除します。よろしいですか？`)) {
            delPack(inputID);
        }
    }

    function delPack(id) {
        const transaction = db.transaction([DATA_STORE], 'readwrite');
        const store = transaction.objectStore(DATA_STORE);
        store.delete(id);
        getPack();
    }

    function updateRestores() {
        //十分早いのでArrayに保持してArrayを編集とかせずに毎回最新のIndexedDBを読み込みに行く
        const transaction = db.transaction([DATA_STORE], 'readonly');
        const store = transaction.objectStore(DATA_STORE);
        const request = store.getAll();

        request.onsuccess = () => {
            const records = request.result;
            document.getElementById('restore').value = JSON.stringify(records);
        }
    }

    function showModalDialog() {
        updateRestores();
        document.getElementById("DIALOG").showModal();  //モーダルでダイアログを表示する。
    }

    function closeDialog(val) {
        if (val.returnValue !== "cancel") {
            if (confirm('記載の呪文で製剤一覧を復活してもよろしいですか？(現在のリストは失われます)')) {
                restoreIndexedDB();
                getPack();
            }
        }
    }

    function restoreIndexedDB() {
        const transaction = db.transaction([DATA_STORE], 'readwrite');
        const store = transaction.objectStore(DATA_STORE);
        store.clear();
        try {
            const restoreJSON = JSON.parse(document.getElementById('restore').value);
            restoreJSON.forEach(pacVal => {
                console.log(pacVal);
                store.put(pacVal);
            });
        } catch (error) {
            alert(error);
        }
    }

    function initializePac() {
        if (confirm('製剤一覧を初期化してもよろしいですか？(現在のリストは失われます)')) {
            makeFirstNutLists();
            getPack();
        }
    }

</script>
</body>

</html>
